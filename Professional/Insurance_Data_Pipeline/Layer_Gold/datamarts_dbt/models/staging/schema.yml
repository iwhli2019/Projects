version: 2

sources:
  - name: main
    schema: main
    description: "The normalized OLTP database generated by the Python pipeline, acting as our Silver Layer."
    tables:
      - name: Dim_Member
        description: "Silver Layer: Normalized, SCD Type 2 table for member demographic and historical data."
        columns:
          - name: member_id
            description: "The natural key for a member, consistent across historical records."
            tests:
              - not_null
          - name: rec_end_date
            description: "The date this version of the member's record expired. NULL indicates the current active record."

      - name: Fact_Claims
        description: "Silver Layer: One record per claim submitted by a member."
        columns:
          - name: claim_id
            description: "The unique primary key for a claim."
            tests:
              - unique
              - not_null
          - name: member_id
            description: "Foreign key to the Dim_Member table."

      - name: Dim_Company
        description: "Silver Layer: A dimension of employer companies and their office locations."
        columns:
          - name: company_id
            description: "The unique primary key for a specific company office location."
            tests:
              - unique
              - not_null

      - name: Dim_Provider
        description: "Silver Layer: A dimension of medical provider organizations/locations."
        columns:
          - name: provider_id
            description: "The unique primary key for a provider organization or location."
            tests:
              - unique
              - not_null

      - name: Dim_Policy
        description: "Silver Layer: A dimension of insurance policies."
        columns:
          - name: policy_id
            description: "The unique primary key for a policy."
            tests:
              - unique
              - not_null

      - name: Dim_Member_Policies
        description: "Silver Layer: A junction table linking members to the policies they are enrolled in over time."
        columns:
          - name: member_policy_id
            description: "The unique primary key for a specific member enrollment."
            tests:
              - unique
              - not_null
          - name: member_id
            description: "Foreign key to the Dim_Member table."
          - name: policy_id
            description: "Foreign key to the Dim_Policy table."

      - name: Fact_Financial_Transactions
        description: "Silver Layer: One record per financial transaction related to a member."
        columns:
          - name: transaction_id
            description: "The unique primary key for a financial transaction."
            tests:
              - unique
              - not_null
          - name: member_id
            description: "Foreign key to the Dim_Member table."

models:
  - name: stg_members
    config:
      schema: "main"
    description: "Cleans and prepares the member data. The grain is one record per version of a member."
    columns:
      - name: member_id
        description: "The primary key for a member."
        tests:
          - not_null

  - name: stg_claims
    config:
      schema: "main"
    description: "Cleans and prepares the claims data. The grain is one record per claim."
    columns:
      - name: claim_id
        description: "The primary key for a claim."
        tests:
          - unique
          - not_null
  
  - name: ClaimsDM
    description: "Gold Layer: A single, wide, denormalized table joining all claims and related dimensions, optimized for analytics."
    config:
      schema: "main"
    columns:
      - name: claim_id
        description: "The unique primary key for the claim transaction."
        tests:
          - unique
          - not_null
      - name: member_id
        description: "The unique ID of the member associated with the claim."
      - name: claim_lag_days
        description: "Calculated Field: The number of days between the service date and the claim submission date."
      - name: member_age_at_service
        description: "Calculated Field: The member's age at the time the service was rendered."
      - name: is_member_active
        description: "Calculated Field: A flag (1/0) indicating if the member's record was active at the time of the query."